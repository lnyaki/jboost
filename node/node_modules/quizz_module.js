
var Quizz = function(){

	/************************************************
	*         Incoming message types
	************************************************/
	//lobby
	var ENTER_LOBBY		= 'enter_lobby';
	var LEAVE_LOBBY		= 'leave_lobby';
	var LOBBY_INFO		= 'lobby_info';
	//Quizz
	var CREATE_QUIZZ	= 'create_quizz';
	var JOIN_QUIZZ		= 'join_quizz';
	var LEAVE_QUIZZ		= 'leave_quizz';
	var VALIDATE_ANSWER = 'validate';
	//USER
	var NEW_USER		= 'new_user';
	//variables
	var rooms;
	var lobbies;
	var games;
	var players;
	
	/************************************************
	*         Outgoing message types
	************************************************/
	var Quizz_Server = function(){
		this.rooms		= new Array();
		this.lobbies	= new Array();
		this.players 	= new Array();
		console.log("IN CONSTRUCTOR");
		console.log(this.lobbies);
		console.log(this);
	};


	Quizz_Server.prototype = function(){
		var constructor = Quizz_Server;
		var http 		= require('http');
		var fs 			= require('fs');
		var Quizz 		= require('Quizz_Game').Quizz;
		var Player		= require('Player').Player;
		var io;
		var server;
		var self;

		var last_game_id	= 0;

		var initialize_server 		= function(port){	 
			 //create the server object
			 server = http.createServer(function(req, res){
			 	fs.readFile('./quizz_client.html', 'utf-8', function(error, content) {
        		res.writeHead(200, {"Content-Type": "text/html"});
        		res.end(content);
     			});
			 });
			 
			 //listen on the chosen port
			 io = require('socket.io').listen(server);
			 //set listening port
			 server.listen(port);
		};
	
	//when a user enters a lobby
		var player_enters_lobby 	= function(socket,lobby,player,player_reference){
			var lobby_ref = lobby.get_reference();

			//add the player to the general players list
			self.players[player_reference] = player;

			//add player in the player list of the lobby
			lobby.add_player(player);
			//add player to the room of the lobby
			socket.join(lobby_ref);
			
			//Emit information to update the view of the players in this room
			io.to(lobby_ref).emit(LOBBY_INFO, self.get_lobbies_data());
			io.to(lobby_ref).emit('message', "User ["+player.get_name()+"] entered Lobby ["+lobby_ref+']');
			
		};
		
		var player_leaves_lobby		= function(lobby_ref, user_ref){
			
		};

		var player_creates_quizz	= function(lobby_ref, user_ref, option){
			
		};
		
		var player_joins_quizz		= function(quizz,lobby_ref,user){
			quizz.add_player(user);
		};

		var player_leaves_quizz 	= function(lobby_ref, quizz_ref,user_ref){

		};

		var create_room				= function(room_name){
			this.rooms.push(room_name);
		};
		
		var create_lobby			= function(lobby){
			this.lobbies[lobby.get_reference()] = lobby;
		};

		var create_game				= function(game_type,data){
			var game = new Quizz();
			this.games.push(game);
			console.log("--------- Game created -----------");
			console.log(game.get_reference());
		};

		var get_lobbies_data		= function(){
				var lobbies_data = new Array();

				for(elt in this.lobbies){
					lobbies_data.push(this.lobbies[elt].get_players_data());
				}
				console.log("------------- Total lobbies data ------------");
				console.log(lobbies_data);
				return lobbies_data;
		};
		
		var get_lobby	= function(reference){
			var lobby = this.lobbies[reference];
			if(lobby != undefined){
				console.log("Lobby found : ");
				console.log(lobby.get_reference());
			}
			else{
				console.log("Can't find lobby : "+reference);
			}
			return lobby;
		};
		//return a lobby element based on its reference
		/*var get_lobby				= function(reference){
			var lobby;
			var found 	= false;
			var exit 	= false;
			var i		= 0;
			var max		= this.lobbies.length;

			while(!exit){
				lobby	= this.lobbies[i];

				if(lobby.get_reference() == reference){
					found 	= true;
					exit 	= true;
				}
				else{
					i++;
					if(i >= max){
						exit = true;
					}
				}
			}

			if(found){
				console.log("Lobby found : ");
				console.log(lobby);
				return lobby;
			}
			else{
				return null;
			}
		};*/
		
		var get_game			= function(reference){
			var game = this.games[reference];
			if(game != undefined){
				console.log("Game found : ");
				console.log(game.get_reference());
			}
			else{
				console.log("Can't find game : "+reference);
			}
			return lobby;
		};
		
		var get_player			= function(){
			
		};
		
		var get_io 					= function(){
			return io;
		};
		
		var events_handling			= function(){
			console.log("----------- dans events handling --------------");
			
			var toto = this;
			self = this;
			
			console.log(this);
			
			//on connection
			io.sockets.on('connection',function(socket){

				socket.emit(LOBBY_INFO, toto.get_lobbies_data());
				
 				socket.on('disconnection',function(){
 					//player_disconnects();
 					console.log("DÃ©connection d'un joueur");
 				});
				
				socket.on('message',function(message){
					console.log("User says : "+message);	
				});
				
			
				//player enters a lobby
				socket.on(ENTER_LOBBY,function(data){
					player_enters_lobby(socket,data.lobby, data.user);
				});
				
				//Create new user
				socket.on(NEW_USER,function(username,user_ref, lobby_ref){
					console.log("------------- LOBBIES & ROOMS -----------");
					console.log(toto.lobbies);
					console.log(toto.rooms);
					//get the lobby and player object.
					var lobby = toto.get_lobby(lobby_ref);
					var user 	= new Player(username,socket);

					if(lobby != null){
						//add the player to the lobby
						player_enters_lobby(socket,lobby, user,user_ref);
					}
					else{
						console.log("Lobby "+lobby_ref+" could not be found. No player added");
					}			

				});
				
				socket.on('create game',function(data){
					var lobbyref = 'Lobby 1';
					var game = new Quizz(io,lobbyref,{});
	
					//quizz,lobby_ref, quizz_ref,user
					player_joins_quizz(game,lobbyref,self.players[data.user_ref]);
					
					console.log("--- Game players -----");
					console.log("- Game : "+game.get_name());
					console.log("- Game reference : "+game.get_reference());
					console.log(game.get_players());
					
					//send the game reference to the user
					
					//create room
					//socket.join(game.get)
				});
				
				socket.on('QUIZZ',function(data){
					//get the game reference
					var game_reference 	= data.gref;
					//get user reference
					var user_reference = data.uref;
					//get the corresponding game
					var game		= self.get_game(game_reference);
					
					if(game != undefined){
						game.on(io,socket,data);
					}
				});
			});
		};
		

		
		return{
			events_handling			: events_handling
			,initialize_server		: initialize_server
			,player_enters_lobby 	: player_enters_lobby
			,player_leaves_lobby	: player_leaves_lobby
			,player_creates_quizz 	: player_creates_quizz
			,player_joins_quizz 	: player_joins_quizz
			,player_leaves_quizz	: player_leaves_quizz
			,get_io					: get_io
			,create_room			: create_room
			,create_lobby			: create_lobby
			,create_game			: create_game
			,get_lobbies_data		: get_lobbies_data
			,get_lobby				: get_lobby
			,get_player				: get_player
			,get_game				: get_game
		};
	}();
	
	return{
		Quizz_Server : Quizz_Server
	};
}();

module.exports	= Quizz;